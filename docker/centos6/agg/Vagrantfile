# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# Vagrantfile   Provision MSM/TSM trustrap services.
#
# Authors:      Paul Gilligan, <Paul.Gilligan@moneysupermarket.com>
#
# Description:  This is a multi-host docker provider provisioning Vagrantfile.
#
# Environment:  You must set some environment values in or to drive this:
#
#               export TRUSTRAP_ACCOUNT=msm    
#               export TRUSTRAP_USERBASE=gb
#               export TRUSTRAP_ENV=dev
#               export TRUSTRAP_SERVICE=agg 
#
#               The TRUSTRAP_SERVICE is new, this represents a group of roles
#               that are defined in the msm-provisoning puppet repository.
#
#               The combination TRUSTRAP_ENV and TRUSTRAP_SERVICE is used to 
#               select a set of roles from the services.yaml file and these
#               values are used to drive the provisioning of individual docker
#               vm's.
#
# Authentication:
#
#               Access to private git repositories (TRUSTRAP_REPONAME) requires
#               you to setup your own git private key on the machine that you
#               run vagrant from, SSH agent forwarding is set to true.
#
# Docker Dev Args:
#
#               Docker extended args for development:
#
#               --privileged=true      Give extended privileges to this container
# 
# Running:      Once you have setup the environment and services.yaml simply
#               run vagrant up.
#
#               You can access your new node from the node name via vargant:
#
#               vagrant ssh msm-gb-dev-agg-lts-mongodb
#
#               You can halt docker containers using vagrant halt.
#
#               You can destroy docker containers using vagrant destroy.
#
#               This has beed designed to be re-entrant, i.e. it can be re-run.    
# 
# Original:     https://github.com/MSMFG/tru-strap
# Git version:  https://github.com/pauldavidgilligan-msm/tru-strap
# Git branch:   handsome-vagrant-docker
#  
# useful links: http://docs.docker.com/reference/builder/#usage
#               https://docs.docker.com/reference/commandline/cli/
#               http://blog.zenika.com/index.php?post/2014/10/07/Setting-up-a-development-environment-using-Docker-and-Vagrant
#               https://github.com/jdeathe/centos-ssh

require 'yaml'
require "resolv"

YAML_OPTIONS = "services.yaml"
VAGRANTFILE_API_VERSION = "2"

def set_fqdn(tag) 
  _fqdn = tag.gsub('_', '.')
  _fqdn = _fqdn.gsub('-', '.')
  return _fqdn.split('.').reverse.join('.') + '.internal'
end

# -----------------------------------------------------------------------------
# Environment Options
# -----------------------------------------------------------------------------
ENV['VAGRANT_DEFAULT_PROVIDER'] = 'docker'

if ENV['TRUSTRAP_ACCOUNT']
    TRUSTRAP_ACCOUNT = ENV['TRUSTRAP_ACCOUNT']
else
  abort("Environment variable: 'TRUSTRAP_ACCOUNT' is not set, exiting ...")
end

if ENV['TRUSTRAP_USERBASE']
    TRUSTRAP_USERBASE = ENV['TRUSTRAP_USERBASE']
else
  abort("Environment variable: 'TRUSTRAP_USERBASE' is not set, exiting ...")
end

if ENV['TRUSTRAP_ENV']
    TRUSTRAP_ENV = ENV['TRUSTRAP_ENV']
else
  abort("Environment variable: 'TRUSTRAP_ENV' is not set, exiting ...")
end

if ENV['TRUSTRAP_SERVICE']
    TRUSTRAP_SERVICE = ENV['TRUSTRAP_SERVICE']
else
  abort("Environment variable: 'TRUSTRAP_SERVICE' is not set, exiting ...")
end

# -----------------------------------------------------------------------------
# Environment Options
# -----------------------------------------------------------------------------
puts "-" * 40
puts "TRUSTRAP, vagrant docker provisioning"
puts "-" * 40
puts "TRUSTRAP_ACCOUNT      #{TRUSTRAP_ACCOUNT}"
puts "TRUSTRAP_USERBASE     #{TRUSTRAP_USERBASE}"
puts "TRUSTRAP_ENV          #{TRUSTRAP_ENV}"
puts "TRUSTRAP_SERVICE      #{TRUSTRAP_SERVICE}"

# -----------------------------------------------------------------------------
# Provision 
# 1. Network Services  (skydns, etcd)
# 2. Business Services (services.yaml)
# -----------------------------------------------------------------------------
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.ssh.username = "dev-opts"
  config.ssh.pty = true
  config.ssh.forward_agent = true

  # -------------------------------------------
  # Provision etcd
  # -------------------------------------------
  config.vm.define "etcd" do |m|
    m.vm.provider "docker" do |vm|
      vm.name            = "etcd.msm.internal"
      vm.image           = "registry1-eu1.moneysupermarket.com:5000/etcd"
      vm.has_ssh         = false
      vm.create_args     = ["--dns=8.8.8.8", "--dns=4.4.4.4"]
      vm.vagrant_machine = "dockerhost"
      vm.vagrant_vagrantfile = "../Vagrantfile.proxy"
    end
  end

  # -------------------------------------------
  # Provision skydns
  # -------------------------------------------
  config.vm.define "skydns" do |m|
    m.vm.provider "docker" do |vm|
      vm.name            = "skydns.msm.internal"
      vm.image           = "registry1-eu1.moneysupermarket.com:5000/skydns"
      vm.has_ssh         = false
      vm.create_args     = ["--dns=8.8.8.8", "--dns=4.4.4.4"]
      vm.vagrant_machine = "dockerhost"
      vm.vagrant_vagrantfile = "../Vagrantfile.proxy"
      vm.link("etcd.msm.internal:etcd.msm.internal")
    end
  end

  # TODO: Looks like we might need a vagrant plugin
  puts "-" * 40
  puts "Pause, allow Docker to respond to Network Service changes"
  sleep 5

  # best ask docker for the IP
  begin
    puts "-" * 40
    skydns_ip_raw1 = %x( docker inspect skydns.msm.internal | grep IPAddress )
    skydns_ip_raw2 = skydns_ip_raw1.split(':')[1].chop.chop
    @skydns_ip = skydns_ip_raw2.gsub('"', '').gsub(' ', '')
    if @skydns_ip =~ Resolv::IPv4::Regex ? true : false 
      puts "Resolved valid IP for skydns container:"
      puts "==> #{@skydns_ip}"
    else
      abort("Could not correctly resolve skydns IP [#{@skydns_ip}], exiting ...")
    end
  rescue
    puts "Skipping skydns IP lookup..."
  end
  
  # -------------------------------------------
  # Provision Business Serivices
  # -------------------------------------------
  config_options = YAML.load_file(YAML_OPTIONS)
  services = config_options['services']
  services.each do |service, params|
    if service == "#{TRUSTRAP_ENV}-#{TRUSTRAP_SERVICE}"
      puts "-" * 40
      puts "Processing service options for [#{TRUSTRAP_ENV}-#{TRUSTRAP_SERVICE}]" 
      dns = params.detect {|param| param['dns']}
      TRUSTRAP_DNS_ARG = "\"--dns=#{dns['dns'][0]['dns-1']}\", \"--dns=#{dns['dns'][1]['dns-2']}\""
      puts "Set DNS #{TRUSTRAP_DNS_ARG}"
      git = params.detect {|param| param['git']}
      TRUSTRAP_REPONAME   = "#{git['git'][0]['reponame']}"
      TRUSTRAP_REPOUSER   = "#{git['git'][1]['repouser']}"
      TRUSTRAP_REPOBRANCH = "#{git['git'][2]['repobranch']}"
      rls = params.detect {|param| param['roles']}

      puts "-" * 40
      puts "TRUSTRAP_REPOUSER     #{TRUSTRAP_REPOUSER}"
      puts "TRUSTRAP_REPONAME     #{TRUSTRAP_REPONAME}"
      puts "TRUSTRAP_REPOBRANCH   #{TRUSTRAP_REPOBRANCH}"
      puts "=" * 40

      # provision multi-machines
      rls.each do |key, value|
        data_set =  value.select {|d| d['data']}
        app_set  =  value.select {|a| a['app']}
        # provision data
        data_set.each do |d|
          if d['enabled'] 
            _role = "#{d['data']}"
            _ts_args = "-r #{_role} -e #{TRUSTRAP_ENV} -u #{TRUSTRAP_REPOUSER} -n #{TRUSTRAP_REPONAME} -b #{TRUSTRAP_REPOBRANCH}"
            _tag = "#{TRUSTRAP_ACCOUNT}-#{TRUSTRAP_USERBASE}-#{TRUSTRAP_ENV}-#{_role}"
            _fqdn = set_fqdn(_tag)
            _search = _fqdn.split('.')[-5..-1].join('.')
            puts "Provisioning role #{_role} docker(enabled) fqdn [#{_fqdn}] for data tier."
              config.vm.define "#{_tag}" do |m|
                m.vm.provider "docker" do |vm|
                  vm.has_ssh = true
                  vm.build_dir = "."
                  vm.build_args = ["--tag=#{_tag}"]
                  if d['ports'] 
                    vm.ports = d['ports'] 
                  end
                  vm.create_args = ["--privileged", "--dns-search=msm.internal", "--dns=#{@skydns_ip}", "--dns=8.8.8.8", "--hostname=#{_fqdn}"]
                  vm.vagrant_machine = "dockerhost"
                  vm.vagrant_vagrantfile = "../Vagrantfile.proxy"
                  vm.link("etcd.msm.internal:etcd.msm.internal")
                  vm.link("skydns.msm.internal:skydns.msm.internal")
                end
              end 
             config.vm.provision "shell", inline: "echo node #{_tag} is very handsome!"
             # config.vm.provision :shell, :path => "init.sh", :args => _ts_args
          end
        end 
      end # rls.each do |key, value|
    else
      abort("Service variable: #{TRUSTRAP_ENV}-#{TRUSTRAP_SERVICE} is not set in file #{YAML_OPTIONS}, exiting ...")
  end
end

end


